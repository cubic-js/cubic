"use strict";var t={};function e(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}function n(t,e){return t(e={exports:{}},e.exports),e.exports}var r=n((function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(){this._queue=[],this._pending=!1}return t.prototype.isLocked=function(){return this._pending},t.prototype.acquire=function(){var t=this,e=new Promise((function(e){return t._queue.push(e)}));return this._pending||this._dispatchNext(),e},t.prototype.runExclusive=function(t){return this.acquire().then((function(e){var n;try{n=t()}catch(t){throw e(),t}return Promise.resolve(n).then((function(t){return e(),t}),(function(t){throw e(),t}))}))},t.prototype._dispatchNext=function(){this._queue.length>0?(this._pending=!0,this._queue.shift()(this._dispatchNext.bind(this))):this._pending=!1},t}();e.default=n}));e(r);var o=n((function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.Mutex=r.default}));e(o);o.Mutex;var i=n((function(t){function e(t){return t&&t.__esModule?t.default:t}function n(t,e){return t(e={exports:{}},e.exports),e.exports}var r=n((function(t){!function(e){var n=Object.prototype,r=n.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",s=o.asyncIterator||"@@asyncIterator",c=o.toStringTag||"@@toStringTag",a=e.regeneratorRuntime;if(a)t.exports=a;else{(a=e.regeneratorRuntime=t.exports).wrap=d;var u={},h={};h[i]=function(){return this};var f=Object.getPrototypeOf,l=f&&f(f(T([])));l&&l!==n&&r.call(l,i)&&(h=l);var p=m.prototype=v.prototype=Object.create(h);_.prototype=p.constructor=m,m.constructor=_,m[c]=_.displayName="GeneratorFunction",a.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===_||"GeneratorFunction"===(e.displayName||e.name))},a.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,m):(t.__proto__=m,c in t||(t[c]="GeneratorFunction")),t.prototype=Object.create(p),t},a.awrap=function(t){return{__await:t}},g(w.prototype),w.prototype[s]=function(){return this},a.AsyncIterator=w,a.async=function(t,e,n,r){var o=new w(d(t,e,n,r));return a.isGeneratorFunction(e)?o:o.next().then((function(t){return t.done?t.value:o.next()}))},g(p),p[c]="Generator",p[i]=function(){return this},p.toString=function(){return"[object Generator]"},a.keys=function(t){var e=[];for(var n in t)e.push(n);return e.reverse(),function n(){for(;e.length;){var r=e.pop();if(r in t)return n.value=r,n.done=!1,n}return n.done=!0,n}},a.values=T,S.prototype={constructor:S,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(x),!t)for(var e in this)"t"===e.charAt(0)&&r.call(this,e)&&!isNaN(+e.slice(1))&&(this[e]=void 0)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var e=this;function n(n,r){return s.type="throw",s.arg=t,e.next=n,r&&(e.method="next",e.arg=void 0),!!r}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],s=i.completion;if("root"===i.tryLoc)return n("end");if(i.tryLoc<=this.prev){var c=r.call(i,"catchLoc"),a=r.call(i,"finallyLoc");if(c&&a){if(this.prev<i.catchLoc)return n(i.catchLoc,!0);if(this.prev<i.finallyLoc)return n(i.finallyLoc)}else if(c){if(this.prev<i.catchLoc)return n(i.catchLoc,!0)}else{if(!a)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return n(i.finallyLoc)}}}},abrupt:function(t,e){for(var n=this.tryEntries.length-1;n>=0;--n){var o=this.tryEntries[n];if(o.tryLoc<=this.prev&&r.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=e&&e<=i.finallyLoc&&(i=null);var s=i?i.completion:{};return s.type=t,s.arg=e,i?(this.method="next",this.next=i.finallyLoc,u):this.complete(s)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),u},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.finallyLoc===t)return this.complete(n.completion,n.afterLoc),x(n),u}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.tryLoc===t){var r=n.completion;if("throw"===r.type){var o=r.arg;x(n)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(t,e,n){return this.delegate={iterator:T(t),resultName:e,nextLoc:n},"next"===this.method&&(this.arg=void 0),u}}}function d(t,e,n,r){var o=e&&e.prototype instanceof v?e:v,i=Object.create(o.prototype),s=new S(r||[]);return i._invoke=function(t,e,n){var r="suspendedStart";return function(o,i){if("executing"===r)throw new Error("Generator is already running");if("completed"===r){if("throw"===o)throw i;return P()}for(n.method=o,n.arg=i;;){var s=n.delegate;if(s){var c=b(s,n);if(c){if(c===u)continue;return c}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if("suspendedStart"===r)throw r="completed",n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);r="executing";var a=y(t,e,n);if("normal"===a.type){if(r=n.done?"completed":"suspendedYield",a.arg===u)continue;return{value:a.arg,done:n.done}}"throw"===a.type&&(r="completed",n.method="throw",n.arg=a.arg)}}}(t,n,s),i}function y(t,e,n){try{return{type:"normal",arg:t.call(e,n)}}catch(t){return{type:"throw",arg:t}}}function v(){}function _(){}function m(){}function g(t){["next","throw","return"].forEach((function(e){t[e]=function(t){return this._invoke(e,t)}}))}function w(t){var e;this._invoke=function(n,o){function i(){return new Promise((function(e,i){!function e(n,o,i,s){var c=y(t[n],t,o);if("throw"!==c.type){var a=c.arg,u=a.value;return u&&"object"==typeof u&&r.call(u,"__await")?Promise.resolve(u.__await).then((function(t){e("next",t,i,s)}),(function(t){e("throw",t,i,s)})):Promise.resolve(u).then((function(t){a.value=t,i(a)}),s)}s(c.arg)}(n,o,e,i)}))}return e=e?e.then(i,i):i()}}function b(t,e){var n=t.iterator[e.method];if(void 0===n){if(e.delegate=null,"throw"===e.method){if(t.iterator.return&&(e.method="return",e.arg=void 0,b(t,e),"throw"===e.method))return u;e.method="throw",e.arg=new TypeError("The iterator does not provide a 'throw' method")}return u}var r=y(n,t.iterator,e.arg);if("throw"===r.type)return e.method="throw",e.arg=r.arg,e.delegate=null,u;var o=r.arg;return o?o.done?(e[t.resultName]=o.value,e.next=t.nextLoc,"return"!==e.method&&(e.method="next",e.arg=void 0),e.delegate=null,u):o:(e.method="throw",e.arg=new TypeError("iterator result is not an object"),e.delegate=null,u)}function k(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function x(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function S(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(k,this),this.reset(!0)}function T(t){if(t){var e=t[i];if(e)return e.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var n=-1,o=function e(){for(;++n<t.length;)if(r.call(t,n))return e.value=t[n],e.done=!1,e;return e.value=void 0,e.done=!0,e};return o.next=o}}return{next:P}}function P(){return{value:void 0,done:!0}}}(function(){return this}()||Function("return this")())})),o=function(){return this}()||Function("return this")(),i=o.regeneratorRuntime&&Object.getOwnPropertyNames(o).indexOf("regeneratorRuntime")>=0,s=i&&o.regeneratorRuntime;o.regeneratorRuntime=void 0;var c=r;if(i)o.regeneratorRuntime=s;else try{delete o.regeneratorRuntime}catch(t){o.regeneratorRuntime=void 0}var a=c,u=Math.ceil,h=Math.floor,f=function(t){return isNaN(t=+t)?0:(t>0?h:u)(t)},l=function(t){if(null==t)throw TypeError("Can't call method on  "+t);return t},p=n((function(t){var e=t.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=e)})),d=n((function(t){var e=t.exports={version:"2.5.1"};"number"==typeof __e&&(__e=e)})),y=function(t){if("function"!=typeof t)throw TypeError(t+" is not a function!");return t},v=function(t,e,n){if(y(t),void 0===e)return t;switch(n){case 1:return function(n){return t.call(e,n)};case 2:return function(n,r){return t.call(e,n,r)};case 3:return function(n,r,o){return t.call(e,n,r,o)}}return function(){return t.apply(e,arguments)}},_=function(t){return"object"==typeof t?null!==t:"function"==typeof t},m=function(t){if(!_(t))throw TypeError(t+" is not an object!");return t},g=function(t){try{return!!t()}catch(t){return!0}},w=!g((function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})),b=p.document,k=_(b)&&_(b.createElement),x=function(t){return k?b.createElement(t):{}},S=!w&&!g((function(){return 7!=Object.defineProperty(x("div"),"a",{get:function(){return 7}}).a})),T=Object.defineProperty,P={f:w?Object.defineProperty:function(t,e,n){if(m(t),e=function(t,e){if(!_(t))return t;var n,r;if(e&&"function"==typeof(n=t.toString)&&!_(r=n.call(t)))return r;if("function"==typeof(n=t.valueOf)&&!_(r=n.call(t)))return r;if(!e&&"function"==typeof(n=t.toString)&&!_(r=n.call(t)))return r;throw TypeError("Can't convert object to primitive value")}(e,!0),m(n),S)try{return T(t,e,n)}catch(t){}if("get"in n||"set"in n)throw TypeError("Accessors not supported!");return"value"in n&&(t[e]=n.value),t}},O=function(t,e){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:e}},C=w?function(t,e,n){return P.f(t,e,O(1,n))}:function(t,e,n){return t[e]=n,t},E=function(t,e,n){var r,o,i,s=t&E.F,c=t&E.G,a=t&E.S,u=t&E.P,h=t&E.B,f=t&E.W,l=c?d:d[e]||(d[e]={}),y=l.prototype,_=c?p:a?p[e]:(p[e]||{}).prototype;for(r in c&&(n=e),n)(o=!s&&_&&void 0!==_[r])&&r in l||(i=o?_[r]:n[r],l[r]=c&&"function"!=typeof _[r]?n[r]:h&&o?v(i,p):f&&_[r]==i?function(t){var e=function(e,n,r){if(this instanceof t){switch(arguments.length){case 0:return new t;case 1:return new t(e);case 2:return new t(e,n)}return new t(e,n,r)}return t.apply(this,arguments)};return e.prototype=t.prototype,e}(i):u&&"function"==typeof i?v(Function.call,i):i,u&&((l.virtual||(l.virtual={}))[r]=i,t&E.R&&y&&!y[r]&&C(y,r,i)))};E.F=1,E.G=2,E.S=4,E.P=8,E.B=16,E.W=32,E.U=64,E.R=128;var L,j=E,M=C,q={}.hasOwnProperty,A=function(t,e){return q.call(t,e)},R={},N={}.toString,I=function(t){return N.call(t).slice(8,-1)},F=Object("z").propertyIsEnumerable(0)?Object:function(t){return"String"==I(t)?t.split(""):Object(t)},G=function(t){return F(l(t))},D=Math.min,B=function(t){return t>0?D(f(t),9007199254740991):0},H=Math.max,U=Math.min,W=p["__core-js_shared__"]||(p["__core-js_shared__"]={}),$=function(t){return W[t]||(W[t]={})},V=0,J=Math.random(),z=function(t){return"Symbol(".concat(void 0===t?"":t,")_",(++V+J).toString(36))},K=$("keys"),X=function(t){return K[t]||(K[t]=z(t))},Y=(L=!1,function(t,e,n){var r,o=G(t),i=B(o.length),s=function(t,e){return(t=f(t))<0?H(t+e,0):U(t,e)}(n,i);if(L&&e!=e){for(;i>s;)if((r=o[s++])!=r)return!0}else for(;i>s;s++)if((L||s in o)&&o[s]===e)return L||s||0;return!L&&-1}),Q=X("IE_PROTO"),Z="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(","),tt=Object.keys||function(t){return function(t,e){var n,r=G(t),o=0,i=[];for(n in r)n!=Q&&A(r,n)&&i.push(n);for(;e.length>o;)A(r,n=e[o++])&&(~Y(i,n)||i.push(n));return i}(t,Z)},et=w?Object.defineProperties:function(t,e){m(t);for(var n,r=tt(e),o=r.length,i=0;o>i;)P.f(t,n=r[i++],e[n]);return t},nt=p.document,rt=nt&&nt.documentElement,ot=X("IE_PROTO"),it=function(){},st=function(){var t,e=x("iframe"),n=Z.length;for(e.style.display="none",rt.appendChild(e),e.src="javascript:",(t=e.contentWindow.document).open(),t.write("<script>document.F=Object<\/script>"),t.close(),st=t.F;n--;)delete st.prototype[Z[n]];return st()},ct=Object.create||function(t,e){var n;return null!==t?(it.prototype=m(t),n=new it,it.prototype=null,n[ot]=t):n=st(),void 0===e?n:et(n,e)},at=n((function(t){var e=$("wks"),n=p.Symbol,r="function"==typeof n;(t.exports=function(t){return e[t]||(e[t]=r&&n[t]||(r?n:z)("Symbol."+t))}).store=e})),ut=P.f,ht=at("toStringTag"),ft=function(t,e,n){t&&!A(t=n?t:t.prototype,ht)&&ut(t,ht,{configurable:!0,value:e})},lt={};C(lt,at("iterator"),(function(){return this}));var pt,dt=function(t,e,n){t.prototype=ct(lt,{next:O(1,n)}),ft(t,e+" Iterator")},yt=X("IE_PROTO"),vt=Object.prototype,_t=Object.getPrototypeOf||function(t){return t=Object(l(t)),A(t,yt)?t[yt]:"function"==typeof t.constructor&&t instanceof t.constructor?t.constructor.prototype:t instanceof Object?vt:null},mt=at("iterator"),gt=!([].keys&&"next"in[].keys()),wt=function(){return this},bt=function(t,e,n,r,o,i,s){dt(n,e,r);var c,a,u,h=function(t){if(!gt&&t in d)return d[t];switch(t){case"keys":case"values":return function(){return new n(this,t)}}return function(){return new n(this,t)}},f=e+" Iterator",l="values"==o,p=!1,d=t.prototype,y=d[mt]||d["@@iterator"]||o&&d[o],v=y||h(o),_=o?l?h("entries"):v:void 0,m="Array"==e&&d.entries||y;if(m&&(u=_t(m.call(new t)))!==Object.prototype&&u.next&&ft(u,f,!0),l&&y&&"values"!==y.name&&(p=!0,v=function(){return y.call(this)}),s&&(gt||p||!d[mt])&&C(d,mt,v),R[e]=v,R[f]=wt,o)if(c={values:l?v:h("values"),keys:i?v:h("keys"),entries:_},s)for(a in c)a in d||M(d,a,c[a]);else j(j.P+j.F*(gt||p),e,c);return c},kt=(pt=!0,function(t,e){var n,r,o=String(l(t)),i=f(e),s=o.length;return i<0||i>=s?pt?"":void 0:(n=o.charCodeAt(i))<55296||n>56319||i+1===s||(r=o.charCodeAt(i+1))<56320||r>57343?pt?o.charAt(i):n:pt?o.slice(i,i+2):r-56320+(n-55296<<10)+65536});bt(String,"String",(function(t){this._t=String(t),this._i=0}),(function(){var t,e=this._t,n=this._i;return n>=e.length?{value:void 0,done:!0}:(t=kt(e,n),this._i+=t.length,{value:t,done:!1})}));var xt=function(t,e){return{value:e,done:!!t}};bt(Array,"Array",(function(t,e){this._t=G(t),this._i=0,this._k=e}),(function(){var t=this._t,e=this._k,n=this._i++;return!t||n>=t.length?(this._t=void 0,xt(1)):xt(0,"keys"==e?n:"values"==e?t[n]:[n,t[n]])}),"values");R.Arguments=R.Array;for(var St=at("toStringTag"),Tt="CSSRuleList,CSSStyleDeclaration,CSSValueList,ClientRectList,DOMRectList,DOMStringList,DOMTokenList,DataTransferItemList,FileList,HTMLAllCollection,HTMLCollection,HTMLFormElement,HTMLSelectElement,MediaList,MimeTypeArray,NamedNodeMap,NodeList,PaintRequestList,Plugin,PluginArray,SVGLengthList,SVGNumberList,SVGPathSegList,SVGPointList,SVGStringList,SVGTransformList,SourceBufferList,StyleSheetList,TextTrackCueList,TextTrackList,TouchList".split(","),Pt=0;Pt<Tt.length;Pt++){var Ot=Tt[Pt],Ct=p[Ot],Et=Ct&&Ct.prototype;Et&&!Et[St]&&C(Et,St,Ot),R[Ot]=R.Array}var Lt,jt,Mt,qt=at("toStringTag"),At="Arguments"==I(function(){return arguments}()),Rt=function(t){var e,n,r;return void 0===t?"Undefined":null===t?"Null":"string"==typeof(n=function(t,e){try{return t[e]}catch(t){}}(e=Object(t),qt))?n:At?I(e):"Object"==(r=I(e))&&"function"==typeof e.callee?"Arguments":r},Nt=function(t,e,n,r){try{return r?e(m(n)[0],n[1]):e(n)}catch(e){var o=t.return;throw void 0!==o&&m(o.call(t)),e}},It=at("iterator"),Ft=Array.prototype,Gt=at("iterator"),Dt=d.getIteratorMethod=function(t){if(null!=t)return t[Gt]||t["@@iterator"]||R[Rt(t)]},Bt=n((function(t){var e={},n={},r=t.exports=function(t,r,o,i,s){var c,a,u,h,f,l=s?function(){return t}:Dt(t),p=v(o,i,r?2:1),d=0;if("function"!=typeof l)throw TypeError(t+" is not iterable!");if(void 0===(f=l)||R.Array!==f&&Ft[It]!==f){for(u=l.call(t);!(a=u.next()).done;)if((h=Nt(u,p,a.value,r))===e||h===n)return h}else for(c=B(t.length);c>d;d++)if((h=r?p(m(a=t[d])[0],a[1]):p(t[d]))===e||h===n)return h};r.BREAK=e,r.RETURN=n})),Ht=at("species"),Ut=function(t,e){var n,r=m(t).constructor;return void 0===r||null==(n=m(r)[Ht])?e:y(n)},Wt=function(t,e,n){var r=void 0===n;switch(e.length){case 0:return r?t():t.call(n);case 1:return r?t(e[0]):t.call(n,e[0]);case 2:return r?t(e[0],e[1]):t.call(n,e[0],e[1]);case 3:return r?t(e[0],e[1],e[2]):t.call(n,e[0],e[1],e[2]);case 4:return r?t(e[0],e[1],e[2],e[3]):t.call(n,e[0],e[1],e[2],e[3])}return t.apply(n,e)},$t=p.process,Vt=p.setImmediate,Jt=p.clearImmediate,zt=p.MessageChannel,Kt=p.Dispatch,Xt=0,Yt={},Qt=function(){var t=+this;if(Yt.hasOwnProperty(t)){var e=Yt[t];delete Yt[t],e()}},Zt=function(t){Qt.call(t.data)};Vt&&Jt||(Vt=function(t){for(var e=[],n=1;arguments.length>n;)e.push(arguments[n++]);return Yt[++Xt]=function(){Wt("function"==typeof t?t:Function(t),e)},Lt(Xt),Xt},Jt=function(t){delete Yt[t]},"process"==I($t)?Lt=function(t){$t.nextTick(v(Qt,t,1))}:Kt&&Kt.now?Lt=function(t){Kt.now(v(Qt,t,1))}:zt?(Mt=(jt=new zt).port2,jt.port1.onmessage=Zt,Lt=v(Mt.postMessage,Mt,1)):p.addEventListener&&"function"==typeof postMessage&&!p.importScripts?(Lt=function(t){p.postMessage(t+"","*")},p.addEventListener("message",Zt,!1)):Lt="onreadystatechange"in x("script")?function(t){rt.appendChild(x("script")).onreadystatechange=function(){rt.removeChild(this),Qt.call(t)}}:function(t){setTimeout(v(Qt,t,1),0)});var te={set:Vt,clear:Jt},ee=te.set,ne=p.MutationObserver||p.WebKitMutationObserver,re=p.process,oe=p.Promise,ie="process"==I(re);function se(t){var e,n;this.promise=new t((function(t,r){if(void 0!==e||void 0!==n)throw TypeError("Bad Promise constructor");e=t,n=r})),this.resolve=y(e),this.reject=y(n)}var ce={f:function(t){return new se(t)}},ae=function(t){try{return{e:!1,v:t()}}catch(t){return{e:!0,v:t}}},ue=function(t,e){if(m(t),_(e)&&e.constructor===t)return e;var n=ce.f(t);return(0,n.resolve)(e),n.promise},he=at("species"),fe=at("iterator"),le=!1;try{[7][fe]().return=function(){le=!0}}catch(t){}var pe,de,ye,ve,_e,me,ge=te.set,we=function(){var t,e,n,r=function(){var r,o;for(ie&&(r=re.domain)&&r.exit();t;){o=t.fn,t=t.next;try{o()}catch(r){throw t?n():e=void 0,r}}e=void 0,r&&r.enter()};if(ie)n=function(){re.nextTick(r)};else if(ne){var o=!0,i=document.createTextNode("");new ne(r).observe(i,{characterData:!0}),n=function(){i.data=o=!o}}else if(oe&&oe.resolve){var s=oe.resolve();n=function(){s.then(r)}}else n=function(){ee.call(p,r)};return function(r){var o={fn:r,next:void 0};e&&(e.next=o),t||(t=o,n()),e=o}}(),be=p.TypeError,ke=p.process,xe=p.Promise,Se="process"==Rt(ke),Te=function(){},Pe=de=ce.f,Oe=!!function(){try{var t=xe.resolve(1),e=(t.constructor={})[at("species")]=function(t){t(Te,Te)};return(Se||"function"==typeof PromiseRejectionEvent)&&t.then(Te)instanceof e}catch(t){}}(),Ce=function(t){var e;return!(!_(t)||"function"!=typeof(e=t.then))&&e},Ee=function(t,e){if(!t._n){t._n=!0;var n=t._c;we((function(){for(var r=t._v,o=1==t._s,i=0,s=function(e){var n,i,s=o?e.ok:e.fail,c=e.resolve,a=e.reject,u=e.domain;try{s?(o||(2==t._h&&Me(t),t._h=1),!0===s?n=r:(u&&u.enter(),n=s(r),u&&u.exit()),n===e.promise?a(be("Promise-chain cycle")):(i=Ce(n))?i.call(n,c,a):c(n)):a(r)}catch(t){a(t)}};n.length>i;)s(n[i++]);t._c=[],t._n=!1,e&&!t._h&&Le(t)}))}},Le=function(t){ge.call(p,(function(){var e,n,r,o=t._v,i=je(t);if(i&&(e=ae((function(){Se?ke.emit("unhandledRejection",o,t):(n=p.onunhandledrejection)?n({promise:t,reason:o}):(r=p.console)&&r.error&&r.error("Unhandled promise rejection",o)})),t._h=Se||je(t)?2:1),t._a=void 0,i&&e.e)throw e.v}))},je=function(t){if(1==t._h)return!1;for(var e,n=t._a||t._c,r=0;n.length>r;)if((e=n[r++]).fail||!je(e.promise))return!1;return!0},Me=function(t){ge.call(p,(function(){var e;Se?ke.emit("rejectionHandled",t):(e=p.onrejectionhandled)&&e({promise:t,reason:t._v})}))},qe=function(t){var e=this;e._d||(e._d=!0,(e=e._w||e)._v=t,e._s=2,e._a||(e._a=e._c.slice()),Ee(e,!0))},Ae=function(t){var e,n=this;if(!n._d){n._d=!0,n=n._w||n;try{if(n===t)throw be("Promise can't be resolved itself");(e=Ce(t))?we((function(){var r={_w:n,_d:!1};try{e.call(t,v(Ae,r,1),v(qe,r,1))}catch(t){qe.call(r,t)}})):(n._v=t,n._s=1,Ee(n,!1))}catch(t){qe.call({_w:n,_d:!1},t)}}};Oe||(xe=function(t){!function(t,e,n,r){if(!(t instanceof e)||void 0!==r&&r in t)throw TypeError(n+": incorrect invocation!")}(this,xe,"Promise","_h"),y(t),pe.call(this);try{t(v(Ae,this,1),v(qe,this,1))}catch(t){qe.call(this,t)}},(pe=function(t){this._c=[],this._a=void 0,this._s=0,this._d=!1,this._v=void 0,this._h=0,this._n=!1}).prototype=function(t,e,n){for(var r in e)n&&t[r]?t[r]=e[r]:C(t,r,e[r]);return t}(xe.prototype,{then:function(t,e){var n=Pe(Ut(this,xe));return n.ok="function"!=typeof t||t,n.fail="function"==typeof e&&e,n.domain=Se?ke.domain:void 0,this._c.push(n),this._a&&this._a.push(n),this._s&&Ee(this,!1),n.promise},catch:function(t){return this.then(void 0,t)}}),ye=function(){var t=new pe;this.promise=t,this.resolve=v(Ae,t,1),this.reject=v(qe,t,1)},ce.f=Pe=function(t){return t===xe||t===ve?new ye(t):de(t)}),j(j.G+j.W+j.F*!Oe,{Promise:xe}),ft(xe,"Promise"),me="function"==typeof d[_e="Promise"]?d[_e]:p[_e],w&&me&&!me[he]&&P.f(me,he,{configurable:!0,get:function(){return this}}),ve=d.Promise,j(j.S+j.F*!Oe,"Promise",{reject:function(t){var e=Pe(this);return(0,e.reject)(t),e.promise}}),j(j.S+!0*j.F,"Promise",{resolve:function(t){return ue(this===ve?xe:this,t)}}),j(j.S+j.F*!(Oe&&function(t,e){if(!e&&!le)return!1;var n=!1;try{var r=[7],o=r[fe]();o.next=function(){return{done:n=!0}},r[fe]=function(){return o},t(r)}catch(t){}return n}((function(t){xe.all(t).catch(Te)}))),"Promise",{all:function(t){var e=this,n=Pe(e),r=n.resolve,o=n.reject,i=ae((function(){var n=[],i=0,s=1;Bt(t,!1,(function(t){var c=i++,a=!1;n.push(void 0),s++,e.resolve(t).then((function(t){a||(a=!0,n[c]=t,--s||r(n))}),o)})),--s||r(n)}));return i.e&&o(i.v),n.promise},race:function(t){var e=this,n=Pe(e),r=n.reject,o=ae((function(){Bt(t,!1,(function(t){e.resolve(t).then(n.resolve,r)}))}));return o.e&&r(o.v),n.promise}}),j(j.P+j.R,"Promise",{finally:function(t){var e=Ut(this,d.Promise||p.Promise),n="function"==typeof t;return this.then(n?function(n){return ue(e,t()).then((function(){return n}))}:t,n?function(n){return ue(e,t()).then((function(){throw n}))}:t)}}),j(j.S,"Promise",{try:function(t){var e=ce.f(this),n=ae(t);return(n.e?e.reject:e.resolve)(n.v),e.promise}});var Re=d.Promise,Ne=n((function(t){t.exports={default:Re,__esModule:!0}})),Ie=e(Ne),Fe=e(n((function(t,e){e.__esModule=!0;var n,r=(n=Ne)&&n.__esModule?n:{default:n};e.default=function(t){return function(){var e=t.apply(this,arguments);return new r.default((function(t,n){return function o(i,s){try{var c=e[i](s),a=c.value}catch(t){return void n(t)}if(!c.done)return r.default.resolve(a).then((function(t){o("next",t)}),(function(t){o("throw",t)}));t(a)}("next")}))}}}))),Ge=e(n((function(t,e){e.__esModule=!0,e.default=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}})));j(j.S+j.F*!w,"Object",{defineProperty:P.f});var De=d.Object,Be=function(t,e,n){return De.defineProperty(t,e,n)},He=n((function(t){t.exports={default:Be,__esModule:!0}}));e(He);var Ue=e(n((function(t,e){e.__esModule=!0;var n,r=(n=He)&&n.__esModule?n:{default:n};e.default=function(){function t(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),(0,r.default)(t,o.key,o)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}()}))),We=function(t,e){return new Ie((function(n){return setTimeout((function(){return n(t())}),e)}))},$e=function(){function t(){Ge(this,t),this.stack=[],this.executing=null,this.throwOnTimeout=!1}return Ue(t,[{key:"delay",value:function(t,e){var n=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:6e4,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"push";return new Ie((function(i,s){var c=n.modFunction(t,e,r,i,s);n.stack[0]&&"unshift"===o?n.stack.splice(1,0,c):n.stack[o](c),n.run()}))}},{key:"modFunction",value:function(t,e,n,r,o){var i=this;return Fe(a.mark((function s(){var c,u;return a.wrap((function(s){for(;;)switch(s.prev=s.next){case 0:return c=new Ie((function(r){We(t,e).then(r),setTimeout((function(){var e="Queued function timed out! ("+(t.name||"anonymous")+")";i.throwOnTimeout&&o(e),r(e)}),n)})),s.next=3,c;case 3:u=s.sent,i.stack.shift(),i.stack[0]?(i.executing=!0,r(u),i.stack[0]()):(i.executing=!1,r(u));case 6:case"end":return s.stop()}}),s,i)})))}},{key:"run",value:function(){this.executing||(this.executing=!0,this.stack[0]())}}]),t}();t.exports=new $e}));e(i);const s=o.Mutex,c=1;var a=class{constructor(t,e){this.url=t,this.options=e,this.timeout=3e4,this.req={delay:this.options.requestDelay||500,counter:0},this.reconnect={delay:this.options.reconnectDelay||500,counter:0},this.lastHeartbeat=new Date,this.subscriptions=[],this.requests=[],this.requestIds=1,this.queue=i,this.mutex=new s,setInterval(async()=>{new Date-this.lastHeartbeat>this.timeout&&this.isConnected()&&this.connection.close(1001,"Heartbeat took too long.")},this.timeout)}async connect(){const t=await this.mutex.acquire();await this._createConnection(),t()}awaitConnection(){return new Promise(t=>{const e=setInterval(()=>{this.connection&&this.connection.readyState===c&&(clearInterval(e),t())},100)})}isConnected(){return this.connection&&this.connection.readyState===c}async request(t,e){await this.awaitConnection();const n=await new Promise(n=>{const r=this.requestIds++,o={action:t,id:r};"string"==typeof e?o.url=e:(o.url=e.url,o.body=e.body),this.requests.push({id:r,resolve:n,verb:t,query:e});try{this.connection.send(JSON.stringify(o))}catch(t){this.requests.pop(),this.client.emit("error",t)}});return this._errCheck(n,t,e)}async reloadConnection(){await this.awaitConnection(),await this.connection.close(1001,"Reloading connection.")}async _retry(t,e,n){const r=t.body&&t.body.reason?parseInt(t.body.reason.replace(/[^0-9]+/g,"")):null,o=isNaN(r)?this.req.delay:r,i=this.queue.delay(this.request.bind(this,e,n),o*Math.pow(2,this.req.counter),5e3,"unshift");return this.req.counter++,i}async _reconnect(){if(this.connection&&this.connection.readyState<=c)return;const t=await this.mutex.acquire();await new Promise(t=>setTimeout(()=>t(),this.reconnect.delay*Math.pow(2,this.reconnect.counter))),this.reconnect.counter++,await this._createConnection(),t();for(let t=this.requests.length-1;t>=0;t--){const t=this.requests.pop();t.resolve(this._retry({},t.verb,t.query))}for(const t of this.subscriptions)this.client.send(JSON.stringify({action:"SUBSCRIBE",room:t.room}))}async _createConnection(){const e=this.apiAccessToken?{headers:{authorization:`bearer ${this.apiAccessToken}`}}:{},n=new t(this.url,e);n.onerror=t=>console.log(`WebSocket Error: ${t.message}`),n.onclose=t=>{1e3!==t.code&&this._reconnect()},n.onmessage=t=>this._onMessage(t.data),this.connection=n}async _onMessage(t){if("string"==typeof(t=JSON.parse(t))&&t.startsWith("primus::ping::"))this.lastHeartbeat=new Date,this.connection.send(JSON.stringify(t.replace("ping","pong"))),this.reconnect.counter=0;else if("RES"===t.action&&t.id){const e=this.requests.find(e=>e.id===t.id);e&&(this.requests=this.requests.filter(e=>e.id!==t.id),e.resolve(t))}else if("PUBLISH"===t.action)for(const e of this.subscriptions)e.room===t.room&&e.fn(t.data)}async _errCheck(t,e,n){if("string"==typeof t&&t.includes("timed out"))return this._retry(t,e,n);if(t.body.error)throw t;return this.req.counter=0,t.body}};class u extends Error{constructor({statusCode:t,body:e},n){const r=e.error?e.error+`(${e.reason})`:e;super(`Cubic-client encountered an error while requesting ${n.url||n}: ${t} - ${r}`),this.statusCode=t,this.reason=e.reason,this.error=e.error}}var h=u;var f=class extends a{async setAccessToken(t){this.apiAccessToken=t}async _errCheck(t,e,n){if("string"==typeof t&&t.includes("timed out"))return this._retry(t,e,n);if(t.body&&t.body.reason&&t.body.reason.includes("jwt expired"))return{EXPIRED:!0,fn:this._retry.bind(this,t,e,n)};if(!t.statusCode&&t.includes("timed out"))return this._retry(t,e,n);if(429===t.statusCode)return this._retry(t,e,n);if(503===t.statusCode)return this._retry(t,e,n);if(parseInt(t.statusCode.toString()[0])>3)throw new h(t,n);return this.req.counter=0,t.body}};const l=o.Mutex;var p=class extends a{constructor(t,e){super(t,e),this.authMutex=new l}async authorize(t=this.refresh_token){if(t||this.options.user_key&&this.options.user_secret)return t?this._refreshToken():this._getTokens()}login(t,e){return this.options.user_key=t,this.options.user_secret=e,this._getTokens()}async _getTokens(){const t={user_key:this.options.user_key,user_secret:this.options.user_secret},e=await this.request("POST",{url:"/authenticate",body:t});this.access_token=e.access_token,this.refresh_token=e.refresh_token}async _refreshToken(){const t=await this.authMutex.acquire(),e={refresh_token:this.refresh_token},n=await this.request("POST",{url:"/refresh",body:e});this.access_token=n.access_token,t()}async _errCheck(t,e,n){return"string"==typeof t&&t.includes("timed out")?this._retry(t,e,n):t.statusCode>=400&&503!==t.statusCode&&404!==t.statusCode&&429!==t.statusCode?(console.error("Cubic-client encountered an error while authenticating:"),console.error(t.body),console.error("retrying... \n"),this._retry(t,e,n)):(this.req.counter=0,t.body)}};var d=class{constructor(t){this.options=t,this.options.isBrowser||(this.api=new f(this.options.api_url,this.options),this.auth=new p(this.options.auth_url,{user_key:this.options.user_key,user_secret:this.options.user_secret}))}awaitConnection(){return Promise.all([this.api.awaitConnection(),this.auth.awaitConnection()])}async connect(){await this.auth.connect(),await this.auth.authorize(),await this.api.setAccessToken(this.auth.access_token),await this.api.connect()}async query(t,e){const n=await this.api.request(t,e);return n.EXPIRED?(await this.auth.authorize(),await this.api.setAccessToken(this.auth.access_token),n.fn()):n}async subscribe(t,e){await this.api.awaitConnection(),this.api.connection.send(JSON.stringify({action:"SUBSCRIBE",room:t})),this.api.subscriptions.push({room:t,fn:e})}async unsubscribe(t){await this.api.awaitConnection(),this.api.connection.send(JSON.stringify({action:"UNSUBSCRIBE",room:t})),this.api.subscriptions=this.api.subscriptions.filter(e=>e.room!==t)}async login(t,e){await this.awaitConnection(),await this.auth.login(t,e),await this.api.setAccessToken(this.auth.access_token),await this.api.reloadConnection()}async setAccessToken(t){this.auth.access_token=t,await this.api.setAccessToken(this.auth.access_token),await this.api.reloadConnection()}};var y=class{constructor(t){this.options={api_url:"ws://localhost:3003/ws",auth_url:"ws://localhost:3030/ws",user_key:null,user_secret:null,...t};let e=this.options.api_url,n=this.options.auth_url;this.options.api_url="/"===e[e.length-1]?e.slice(0,-1):e,this.options.auth_url="/"===n[n.length-1]?n.slice(0,-1):n,this._createClient()}awaitConnection(){return this.client.awaitConnection()}isConnected(){return this.client.api.isConnected()}subscribe(t,e){return this.client.subscribe(t,e)}unsubscribe(t){return this.client.unsubscribe(t)}query(t,e){return this.client.query(t,e)}get(t){return this.query("GET",t)}post(t,e){return this.query("POST",{url:t,body:e})}put(t,e){return this.query("PUT",{url:t,body:e})}patch(t,e){return this.query("PATCH",{url:t,body:e})}delete(t,e){return this.query("DELETE",{url:t,body:e})}login(t,e){return this.client.login(t,e)}async setRefreshToken(t){this.client.auth.refresh_token=t}async getRefreshToken(){return this.client.auth.refresh_token}setAccessToken(t){return this.client.setAccessToken(t)}async getAccessToken(){return this.client.auth.access_token}_createClient(){this.client=new d(this.options),this.client.connect()}};class v extends a{async _createConnection(){const t=new WebSocket(this.apiAccessToken?`${this.url}?bearer=${this.apiAccessToken}`:this.url);t.onerror=t=>console.log(`WebSocket Error: ${t.message}`),t.onclose=t=>{1e3!==t.code&&this._reconnect()},t.onmessage=t=>this._onMessage(t.data),this.connection=t}}class _ extends p{}_.prototype._createConnection=v.prototype._createConnection;class m extends f{}m.prototype._createConnection=v.prototype._createConnection;class g extends d{constructor(t){t.isBrowser=!0,super(t),this.api=new m(this.options.api_url,this.options),this.auth=new _(this.options.auth_url,{user_key:this.options.user_key,user_secret:this.options.user_secret})}}module.exports=class extends y{_createClient(){this.client=new g(this.options),this.client.connect()}};
//# sourceMappingURL=browser.js.map
