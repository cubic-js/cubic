"use strict";var t={};function e(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}function n(t,e){return t(e={exports:{}},e.exports),e.exports}var r=n((function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(){this._queue=[],this._pending=!1}return t.prototype.isLocked=function(){return this._pending},t.prototype.acquire=function(){var t=this,e=new Promise((function(e){return t._queue.push(e)}));return this._pending||this._dispatchNext(),e},t.prototype.runExclusive=function(t){return this.acquire().then((function(e){var n;try{n=t()}catch(t){throw e(),t}return Promise.resolve(n).then((function(t){return e(),t}),(function(t){throw e(),t}))}))},t.prototype._dispatchNext=function(){this._queue.length>0?(this._pending=!0,this._queue.shift()(this._dispatchNext.bind(this))):this._pending=!1},t}();e.default=n}));e(r);var i=n((function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.Mutex=r.default}));e(i);i.Mutex;var o=n((function(t){function e(t){return t&&t.__esModule?t.default:t}function n(t,e){return t(e={exports:{}},e.exports),e.exports}var r=n((function(t){!function(e){var n=Object.prototype,r=n.hasOwnProperty,i="function"==typeof Symbol?Symbol:{},o=i.iterator||"@@iterator",s=i.asyncIterator||"@@asyncIterator",c=i.toStringTag||"@@toStringTag",u=e.regeneratorRuntime;if(u)t.exports=u;else{(u=e.regeneratorRuntime=t.exports).wrap=d;var a={},h={};h[o]=function(){return this};var f=Object.getPrototypeOf,l=f&&f(f(T([])));l&&l!==n&&r.call(l,o)&&(h=l);var p=m.prototype=v.prototype=Object.create(h);_.prototype=p.constructor=m,m.constructor=_,m[c]=_.displayName="GeneratorFunction",u.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===_||"GeneratorFunction"===(e.displayName||e.name))},u.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,m):(t.__proto__=m,c in t||(t[c]="GeneratorFunction")),t.prototype=Object.create(p),t},u.awrap=function(t){return{__await:t}},g(w.prototype),w.prototype[s]=function(){return this},u.AsyncIterator=w,u.async=function(t,e,n,r){var i=new w(d(t,e,n,r));return u.isGeneratorFunction(e)?i:i.next().then((function(t){return t.done?t.value:i.next()}))},g(p),p[c]="Generator",p[o]=function(){return this},p.toString=function(){return"[object Generator]"},u.keys=function(t){var e=[];for(var n in t)e.push(n);return e.reverse(),function n(){for(;e.length;){var r=e.pop();if(r in t)return n.value=r,n.done=!1,n}return n.done=!0,n}},u.values=T,S.prototype={constructor:S,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(x),!t)for(var e in this)"t"===e.charAt(0)&&r.call(this,e)&&!isNaN(+e.slice(1))&&(this[e]=void 0)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var e=this;function n(n,r){return s.type="throw",s.arg=t,e.next=n,r&&(e.method="next",e.arg=void 0),!!r}for(var i=this.tryEntries.length-1;i>=0;--i){var o=this.tryEntries[i],s=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var c=r.call(o,"catchLoc"),u=r.call(o,"finallyLoc");if(c&&u){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(t,e){for(var n=this.tryEntries.length-1;n>=0;--n){var i=this.tryEntries[n];if(i.tryLoc<=this.prev&&r.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var o=i;break}}o&&("break"===t||"continue"===t)&&o.tryLoc<=e&&e<=o.finallyLoc&&(o=null);var s=o?o.completion:{};return s.type=t,s.arg=e,o?(this.method="next",this.next=o.finallyLoc,a):this.complete(s)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),a},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.finallyLoc===t)return this.complete(n.completion,n.afterLoc),x(n),a}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.tryLoc===t){var r=n.completion;if("throw"===r.type){var i=r.arg;x(n)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(t,e,n){return this.delegate={iterator:T(t),resultName:e,nextLoc:n},"next"===this.method&&(this.arg=void 0),a}}}function d(t,e,n,r){var i=e&&e.prototype instanceof v?e:v,o=Object.create(i.prototype),s=new S(r||[]);return o._invoke=function(t,e,n){var r="suspendedStart";return function(i,o){if("executing"===r)throw new Error("Generator is already running");if("completed"===r){if("throw"===i)throw o;return P()}for(n.method=i,n.arg=o;;){var s=n.delegate;if(s){var c=b(s,n);if(c){if(c===a)continue;return c}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if("suspendedStart"===r)throw r="completed",n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);r="executing";var u=y(t,e,n);if("normal"===u.type){if(r=n.done?"completed":"suspendedYield",u.arg===a)continue;return{value:u.arg,done:n.done}}"throw"===u.type&&(r="completed",n.method="throw",n.arg=u.arg)}}}(t,n,s),o}function y(t,e,n){try{return{type:"normal",arg:t.call(e,n)}}catch(t){return{type:"throw",arg:t}}}function v(){}function _(){}function m(){}function g(t){["next","throw","return"].forEach((function(e){t[e]=function(t){return this._invoke(e,t)}}))}function w(t){var e;this._invoke=function(n,i){function o(){return new Promise((function(e,o){!function e(n,i,o,s){var c=y(t[n],t,i);if("throw"!==c.type){var u=c.arg,a=u.value;return a&&"object"==typeof a&&r.call(a,"__await")?Promise.resolve(a.__await).then((function(t){e("next",t,o,s)}),(function(t){e("throw",t,o,s)})):Promise.resolve(a).then((function(t){u.value=t,o(u)}),s)}s(c.arg)}(n,i,e,o)}))}return e=e?e.then(o,o):o()}}function b(t,e){var n=t.iterator[e.method];if(void 0===n){if(e.delegate=null,"throw"===e.method){if(t.iterator.return&&(e.method="return",e.arg=void 0,b(t,e),"throw"===e.method))return a;e.method="throw",e.arg=new TypeError("The iterator does not provide a 'throw' method")}return a}var r=y(n,t.iterator,e.arg);if("throw"===r.type)return e.method="throw",e.arg=r.arg,e.delegate=null,a;var i=r.arg;return i?i.done?(e[t.resultName]=i.value,e.next=t.nextLoc,"return"!==e.method&&(e.method="next",e.arg=void 0),e.delegate=null,a):i:(e.method="throw",e.arg=new TypeError("iterator result is not an object"),e.delegate=null,a)}function k(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function x(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function S(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(k,this),this.reset(!0)}function T(t){if(t){var e=t[o];if(e)return e.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var n=-1,i=function e(){for(;++n<t.length;)if(r.call(t,n))return e.value=t[n],e.done=!1,e;return e.value=void 0,e.done=!0,e};return i.next=i}}return{next:P}}function P(){return{value:void 0,done:!0}}}(function(){return this}()||Function("return this")())})),i=function(){return this}()||Function("return this")(),o=i.regeneratorRuntime&&Object.getOwnPropertyNames(i).indexOf("regeneratorRuntime")>=0,s=o&&i.regeneratorRuntime;i.regeneratorRuntime=void 0;var c=r;if(o)i.regeneratorRuntime=s;else try{delete i.regeneratorRuntime}catch(t){i.regeneratorRuntime=void 0}var u=c,a=Math.ceil,h=Math.floor,f=function(t){return isNaN(t=+t)?0:(t>0?h:a)(t)},l=function(t){if(null==t)throw TypeError("Can't call method on  "+t);return t},p=n((function(t){var e=t.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=e)})),d=n((function(t){var e=t.exports={version:"2.5.1"};"number"==typeof __e&&(__e=e)})),y=function(t){if("function"!=typeof t)throw TypeError(t+" is not a function!");return t},v=function(t,e,n){if(y(t),void 0===e)return t;switch(n){case 1:return function(n){return t.call(e,n)};case 2:return function(n,r){return t.call(e,n,r)};case 3:return function(n,r,i){return t.call(e,n,r,i)}}return function(){return t.apply(e,arguments)}},_=function(t){return"object"==typeof t?null!==t:"function"==typeof t},m=function(t){if(!_(t))throw TypeError(t+" is not an object!");return t},g=function(t){try{return!!t()}catch(t){return!0}},w=!g((function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})),b=p.document,k=_(b)&&_(b.createElement),x=function(t){return k?b.createElement(t):{}},S=!w&&!g((function(){return 7!=Object.defineProperty(x("div"),"a",{get:function(){return 7}}).a})),T=Object.defineProperty,P={f:w?Object.defineProperty:function(t,e,n){if(m(t),e=function(t,e){if(!_(t))return t;var n,r;if(e&&"function"==typeof(n=t.toString)&&!_(r=n.call(t)))return r;if("function"==typeof(n=t.valueOf)&&!_(r=n.call(t)))return r;if(!e&&"function"==typeof(n=t.toString)&&!_(r=n.call(t)))return r;throw TypeError("Can't convert object to primitive value")}(e,!0),m(n),S)try{return T(t,e,n)}catch(t){}if("get"in n||"set"in n)throw TypeError("Accessors not supported!");return"value"in n&&(t[e]=n.value),t}},O=function(t,e){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:e}},E=w?function(t,e,n){return P.f(t,e,O(1,n))}:function(t,e,n){return t[e]=n,t},L=function(t,e,n){var r,i,o,s=t&L.F,c=t&L.G,u=t&L.S,a=t&L.P,h=t&L.B,f=t&L.W,l=c?d:d[e]||(d[e]={}),y=l.prototype,_=c?p:u?p[e]:(p[e]||{}).prototype;for(r in c&&(n=e),n)(i=!s&&_&&void 0!==_[r])&&r in l||(o=i?_[r]:n[r],l[r]=c&&"function"!=typeof _[r]?n[r]:h&&i?v(o,p):f&&_[r]==o?function(t){var e=function(e,n,r){if(this instanceof t){switch(arguments.length){case 0:return new t;case 1:return new t(e);case 2:return new t(e,n)}return new t(e,n,r)}return t.apply(this,arguments)};return e.prototype=t.prototype,e}(o):a&&"function"==typeof o?v(Function.call,o):o,a&&((l.virtual||(l.virtual={}))[r]=o,t&L.R&&y&&!y[r]&&E(y,r,o)))};L.F=1,L.G=2,L.S=4,L.P=8,L.B=16,L.W=32,L.U=64,L.R=128;var j,C=L,M=E,q={}.hasOwnProperty,A=function(t,e){return q.call(t,e)},R={},N={}.toString,I=function(t){return N.call(t).slice(8,-1)},F=Object("z").propertyIsEnumerable(0)?Object:function(t){return"String"==I(t)?t.split(""):Object(t)},G=function(t){return F(l(t))},D=Math.min,B=function(t){return t>0?D(f(t),9007199254740991):0},H=Math.max,U=Math.min,V=p["__core-js_shared__"]||(p["__core-js_shared__"]={}),W=function(t){return V[t]||(V[t]={})},J=0,$=Math.random(),z=function(t){return"Symbol(".concat(void 0===t?"":t,")_",(++J+$).toString(36))},K=W("keys"),X=function(t){return K[t]||(K[t]=z(t))},Y=(j=!1,function(t,e,n){var r,i=G(t),o=B(i.length),s=function(t,e){return(t=f(t))<0?H(t+e,0):U(t,e)}(n,o);if(j&&e!=e){for(;o>s;)if((r=i[s++])!=r)return!0}else for(;o>s;s++)if((j||s in i)&&i[s]===e)return j||s||0;return!j&&-1}),Q=X("IE_PROTO"),Z="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(","),tt=Object.keys||function(t){return function(t,e){var n,r=G(t),i=0,o=[];for(n in r)n!=Q&&A(r,n)&&o.push(n);for(;e.length>i;)A(r,n=e[i++])&&(~Y(o,n)||o.push(n));return o}(t,Z)},et=w?Object.defineProperties:function(t,e){m(t);for(var n,r=tt(e),i=r.length,o=0;i>o;)P.f(t,n=r[o++],e[n]);return t},nt=p.document,rt=nt&&nt.documentElement,it=X("IE_PROTO"),ot=function(){},st=function(){var t,e=x("iframe"),n=Z.length;for(e.style.display="none",rt.appendChild(e),e.src="javascript:",(t=e.contentWindow.document).open(),t.write("<script>document.F=Object<\/script>"),t.close(),st=t.F;n--;)delete st.prototype[Z[n]];return st()},ct=Object.create||function(t,e){var n;return null!==t?(ot.prototype=m(t),n=new ot,ot.prototype=null,n[it]=t):n=st(),void 0===e?n:et(n,e)},ut=n((function(t){var e=W("wks"),n=p.Symbol,r="function"==typeof n;(t.exports=function(t){return e[t]||(e[t]=r&&n[t]||(r?n:z)("Symbol."+t))}).store=e})),at=P.f,ht=ut("toStringTag"),ft=function(t,e,n){t&&!A(t=n?t:t.prototype,ht)&&at(t,ht,{configurable:!0,value:e})},lt={};E(lt,ut("iterator"),(function(){return this}));var pt,dt=function(t,e,n){t.prototype=ct(lt,{next:O(1,n)}),ft(t,e+" Iterator")},yt=X("IE_PROTO"),vt=Object.prototype,_t=Object.getPrototypeOf||function(t){return t=Object(l(t)),A(t,yt)?t[yt]:"function"==typeof t.constructor&&t instanceof t.constructor?t.constructor.prototype:t instanceof Object?vt:null},mt=ut("iterator"),gt=!([].keys&&"next"in[].keys()),wt=function(){return this},bt=function(t,e,n,r,i,o,s){dt(n,e,r);var c,u,a,h=function(t){if(!gt&&t in d)return d[t];switch(t){case"keys":case"values":return function(){return new n(this,t)}}return function(){return new n(this,t)}},f=e+" Iterator",l="values"==i,p=!1,d=t.prototype,y=d[mt]||d["@@iterator"]||i&&d[i],v=y||h(i),_=i?l?h("entries"):v:void 0,m="Array"==e&&d.entries||y;if(m&&(a=_t(m.call(new t)))!==Object.prototype&&a.next&&ft(a,f,!0),l&&y&&"values"!==y.name&&(p=!0,v=function(){return y.call(this)}),s&&(gt||p||!d[mt])&&E(d,mt,v),R[e]=v,R[f]=wt,i)if(c={values:l?v:h("values"),keys:o?v:h("keys"),entries:_},s)for(u in c)u in d||M(d,u,c[u]);else C(C.P+C.F*(gt||p),e,c);return c},kt=(pt=!0,function(t,e){var n,r,i=String(l(t)),o=f(e),s=i.length;return o<0||o>=s?pt?"":void 0:(n=i.charCodeAt(o))<55296||n>56319||o+1===s||(r=i.charCodeAt(o+1))<56320||r>57343?pt?i.charAt(o):n:pt?i.slice(o,o+2):r-56320+(n-55296<<10)+65536});bt(String,"String",(function(t){this._t=String(t),this._i=0}),(function(){var t,e=this._t,n=this._i;return n>=e.length?{value:void 0,done:!0}:(t=kt(e,n),this._i+=t.length,{value:t,done:!1})}));var xt=function(t,e){return{value:e,done:!!t}};bt(Array,"Array",(function(t,e){this._t=G(t),this._i=0,this._k=e}),(function(){var t=this._t,e=this._k,n=this._i++;return!t||n>=t.length?(this._t=void 0,xt(1)):xt(0,"keys"==e?n:"values"==e?t[n]:[n,t[n]])}),"values");R.Arguments=R.Array;for(var St=ut("toStringTag"),Tt="CSSRuleList,CSSStyleDeclaration,CSSValueList,ClientRectList,DOMRectList,DOMStringList,DOMTokenList,DataTransferItemList,FileList,HTMLAllCollection,HTMLCollection,HTMLFormElement,HTMLSelectElement,MediaList,MimeTypeArray,NamedNodeMap,NodeList,PaintRequestList,Plugin,PluginArray,SVGLengthList,SVGNumberList,SVGPathSegList,SVGPointList,SVGStringList,SVGTransformList,SourceBufferList,StyleSheetList,TextTrackCueList,TextTrackList,TouchList".split(","),Pt=0;Pt<Tt.length;Pt++){var Ot=Tt[Pt],Et=p[Ot],Lt=Et&&Et.prototype;Lt&&!Lt[St]&&E(Lt,St,Ot),R[Ot]=R.Array}var jt,Ct,Mt,qt=ut("toStringTag"),At="Arguments"==I(function(){return arguments}()),Rt=function(t){var e,n,r;return void 0===t?"Undefined":null===t?"Null":"string"==typeof(n=function(t,e){try{return t[e]}catch(t){}}(e=Object(t),qt))?n:At?I(e):"Object"==(r=I(e))&&"function"==typeof e.callee?"Arguments":r},Nt=function(t,e,n,r){try{return r?e(m(n)[0],n[1]):e(n)}catch(e){var i=t.return;throw void 0!==i&&m(i.call(t)),e}},It=ut("iterator"),Ft=Array.prototype,Gt=ut("iterator"),Dt=d.getIteratorMethod=function(t){if(null!=t)return t[Gt]||t["@@iterator"]||R[Rt(t)]},Bt=n((function(t){var e={},n={},r=t.exports=function(t,r,i,o,s){var c,u,a,h,f,l=s?function(){return t}:Dt(t),p=v(i,o,r?2:1),d=0;if("function"!=typeof l)throw TypeError(t+" is not iterable!");if(void 0===(f=l)||R.Array!==f&&Ft[It]!==f){for(a=l.call(t);!(u=a.next()).done;)if((h=Nt(a,p,u.value,r))===e||h===n)return h}else for(c=B(t.length);c>d;d++)if((h=r?p(m(u=t[d])[0],u[1]):p(t[d]))===e||h===n)return h};r.BREAK=e,r.RETURN=n})),Ht=ut("species"),Ut=function(t,e){var n,r=m(t).constructor;return void 0===r||null==(n=m(r)[Ht])?e:y(n)},Vt=function(t,e,n){var r=void 0===n;switch(e.length){case 0:return r?t():t.call(n);case 1:return r?t(e[0]):t.call(n,e[0]);case 2:return r?t(e[0],e[1]):t.call(n,e[0],e[1]);case 3:return r?t(e[0],e[1],e[2]):t.call(n,e[0],e[1],e[2]);case 4:return r?t(e[0],e[1],e[2],e[3]):t.call(n,e[0],e[1],e[2],e[3])}return t.apply(n,e)},Wt=p.process,Jt=p.setImmediate,$t=p.clearImmediate,zt=p.MessageChannel,Kt=p.Dispatch,Xt=0,Yt={},Qt=function(){var t=+this;if(Yt.hasOwnProperty(t)){var e=Yt[t];delete Yt[t],e()}},Zt=function(t){Qt.call(t.data)};Jt&&$t||(Jt=function(t){for(var e=[],n=1;arguments.length>n;)e.push(arguments[n++]);return Yt[++Xt]=function(){Vt("function"==typeof t?t:Function(t),e)},jt(Xt),Xt},$t=function(t){delete Yt[t]},"process"==I(Wt)?jt=function(t){Wt.nextTick(v(Qt,t,1))}:Kt&&Kt.now?jt=function(t){Kt.now(v(Qt,t,1))}:zt?(Mt=(Ct=new zt).port2,Ct.port1.onmessage=Zt,jt=v(Mt.postMessage,Mt,1)):p.addEventListener&&"function"==typeof postMessage&&!p.importScripts?(jt=function(t){p.postMessage(t+"","*")},p.addEventListener("message",Zt,!1)):jt="onreadystatechange"in x("script")?function(t){rt.appendChild(x("script")).onreadystatechange=function(){rt.removeChild(this),Qt.call(t)}}:function(t){setTimeout(v(Qt,t,1),0)});var te={set:Jt,clear:$t},ee=te.set,ne=p.MutationObserver||p.WebKitMutationObserver,re=p.process,ie=p.Promise,oe="process"==I(re);function se(t){var e,n;this.promise=new t((function(t,r){if(void 0!==e||void 0!==n)throw TypeError("Bad Promise constructor");e=t,n=r})),this.resolve=y(e),this.reject=y(n)}var ce={f:function(t){return new se(t)}},ue=function(t){try{return{e:!1,v:t()}}catch(t){return{e:!0,v:t}}},ae=function(t,e){if(m(t),_(e)&&e.constructor===t)return e;var n=ce.f(t);return(0,n.resolve)(e),n.promise},he=ut("species"),fe=ut("iterator"),le=!1;try{[7][fe]().return=function(){le=!0}}catch(t){}var pe,de,ye,ve,_e,me,ge=te.set,we=function(){var t,e,n,r=function(){var r,i;for(oe&&(r=re.domain)&&r.exit();t;){i=t.fn,t=t.next;try{i()}catch(r){throw t?n():e=void 0,r}}e=void 0,r&&r.enter()};if(oe)n=function(){re.nextTick(r)};else if(ne){var i=!0,o=document.createTextNode("");new ne(r).observe(o,{characterData:!0}),n=function(){o.data=i=!i}}else if(ie&&ie.resolve){var s=ie.resolve();n=function(){s.then(r)}}else n=function(){ee.call(p,r)};return function(r){var i={fn:r,next:void 0};e&&(e.next=i),t||(t=i,n()),e=i}}(),be=p.TypeError,ke=p.process,xe=p.Promise,Se="process"==Rt(ke),Te=function(){},Pe=de=ce.f,Oe=!!function(){try{var t=xe.resolve(1),e=(t.constructor={})[ut("species")]=function(t){t(Te,Te)};return(Se||"function"==typeof PromiseRejectionEvent)&&t.then(Te)instanceof e}catch(t){}}(),Ee=function(t){var e;return!(!_(t)||"function"!=typeof(e=t.then))&&e},Le=function(t,e){if(!t._n){t._n=!0;var n=t._c;we((function(){for(var r=t._v,i=1==t._s,o=0,s=function(e){var n,o,s=i?e.ok:e.fail,c=e.resolve,u=e.reject,a=e.domain;try{s?(i||(2==t._h&&Me(t),t._h=1),!0===s?n=r:(a&&a.enter(),n=s(r),a&&a.exit()),n===e.promise?u(be("Promise-chain cycle")):(o=Ee(n))?o.call(n,c,u):c(n)):u(r)}catch(t){u(t)}};n.length>o;)s(n[o++]);t._c=[],t._n=!1,e&&!t._h&&je(t)}))}},je=function(t){ge.call(p,(function(){var e,n,r,i=t._v,o=Ce(t);if(o&&(e=ue((function(){Se?ke.emit("unhandledRejection",i,t):(n=p.onunhandledrejection)?n({promise:t,reason:i}):(r=p.console)&&r.error&&r.error("Unhandled promise rejection",i)})),t._h=Se||Ce(t)?2:1),t._a=void 0,o&&e.e)throw e.v}))},Ce=function(t){if(1==t._h)return!1;for(var e,n=t._a||t._c,r=0;n.length>r;)if((e=n[r++]).fail||!Ce(e.promise))return!1;return!0},Me=function(t){ge.call(p,(function(){var e;Se?ke.emit("rejectionHandled",t):(e=p.onrejectionhandled)&&e({promise:t,reason:t._v})}))},qe=function(t){var e=this;e._d||(e._d=!0,(e=e._w||e)._v=t,e._s=2,e._a||(e._a=e._c.slice()),Le(e,!0))},Ae=function(t){var e,n=this;if(!n._d){n._d=!0,n=n._w||n;try{if(n===t)throw be("Promise can't be resolved itself");(e=Ee(t))?we((function(){var r={_w:n,_d:!1};try{e.call(t,v(Ae,r,1),v(qe,r,1))}catch(t){qe.call(r,t)}})):(n._v=t,n._s=1,Le(n,!1))}catch(t){qe.call({_w:n,_d:!1},t)}}};Oe||(xe=function(t){!function(t,e,n,r){if(!(t instanceof e)||void 0!==r&&r in t)throw TypeError(n+": incorrect invocation!")}(this,xe,"Promise","_h"),y(t),pe.call(this);try{t(v(Ae,this,1),v(qe,this,1))}catch(t){qe.call(this,t)}},(pe=function(t){this._c=[],this._a=void 0,this._s=0,this._d=!1,this._v=void 0,this._h=0,this._n=!1}).prototype=function(t,e,n){for(var r in e)n&&t[r]?t[r]=e[r]:E(t,r,e[r]);return t}(xe.prototype,{then:function(t,e){var n=Pe(Ut(this,xe));return n.ok="function"!=typeof t||t,n.fail="function"==typeof e&&e,n.domain=Se?ke.domain:void 0,this._c.push(n),this._a&&this._a.push(n),this._s&&Le(this,!1),n.promise},catch:function(t){return this.then(void 0,t)}}),ye=function(){var t=new pe;this.promise=t,this.resolve=v(Ae,t,1),this.reject=v(qe,t,1)},ce.f=Pe=function(t){return t===xe||t===ve?new ye(t):de(t)}),C(C.G+C.W+C.F*!Oe,{Promise:xe}),ft(xe,"Promise"),me="function"==typeof d[_e="Promise"]?d[_e]:p[_e],w&&me&&!me[he]&&P.f(me,he,{configurable:!0,get:function(){return this}}),ve=d.Promise,C(C.S+C.F*!Oe,"Promise",{reject:function(t){var e=Pe(this);return(0,e.reject)(t),e.promise}}),C(C.S+!0*C.F,"Promise",{resolve:function(t){return ae(this===ve?xe:this,t)}}),C(C.S+C.F*!(Oe&&function(t,e){if(!e&&!le)return!1;var n=!1;try{var r=[7],i=r[fe]();i.next=function(){return{done:n=!0}},r[fe]=function(){return i},t(r)}catch(t){}return n}((function(t){xe.all(t).catch(Te)}))),"Promise",{all:function(t){var e=this,n=Pe(e),r=n.resolve,i=n.reject,o=ue((function(){var n=[],o=0,s=1;Bt(t,!1,(function(t){var c=o++,u=!1;n.push(void 0),s++,e.resolve(t).then((function(t){u||(u=!0,n[c]=t,--s||r(n))}),i)})),--s||r(n)}));return o.e&&i(o.v),n.promise},race:function(t){var e=this,n=Pe(e),r=n.reject,i=ue((function(){Bt(t,!1,(function(t){e.resolve(t).then(n.resolve,r)}))}));return i.e&&r(i.v),n.promise}}),C(C.P+C.R,"Promise",{finally:function(t){var e=Ut(this,d.Promise||p.Promise),n="function"==typeof t;return this.then(n?function(n){return ae(e,t()).then((function(){return n}))}:t,n?function(n){return ae(e,t()).then((function(){throw n}))}:t)}}),C(C.S,"Promise",{try:function(t){var e=ce.f(this),n=ue(t);return(n.e?e.reject:e.resolve)(n.v),e.promise}});var Re=d.Promise,Ne=n((function(t){t.exports={default:Re,__esModule:!0}})),Ie=e(Ne),Fe=e(n((function(t,e){e.__esModule=!0;var n,r=(n=Ne)&&n.__esModule?n:{default:n};e.default=function(t){return function(){var e=t.apply(this,arguments);return new r.default((function(t,n){return function i(o,s){try{var c=e[o](s),u=c.value}catch(t){return void n(t)}if(!c.done)return r.default.resolve(u).then((function(t){i("next",t)}),(function(t){i("throw",t)}));t(u)}("next")}))}}}))),Ge=e(n((function(t,e){e.__esModule=!0,e.default=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}})));C(C.S+C.F*!w,"Object",{defineProperty:P.f});var De=d.Object,Be=function(t,e,n){return De.defineProperty(t,e,n)},He=n((function(t){t.exports={default:Be,__esModule:!0}}));e(He);var Ue=e(n((function(t,e){e.__esModule=!0;var n,r=(n=He)&&n.__esModule?n:{default:n};e.default=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),(0,r.default)(t,i.key,i)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}()}))),Ve=function(t,e){return new Ie((function(n){return setTimeout((function(){return n(t())}),e)}))},We=function(){function t(){Ge(this,t),this.stack=[],this.executing=null,this.throwOnTimeout=!1}return Ue(t,[{key:"delay",value:function(t,e){var n=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:6e4,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"push";return new Ie((function(o,s){var c=n.modFunction(t,e,r,o,s);n.stack[0]&&"unshift"===i?n.stack.splice(1,0,c):n.stack[i](c),n.run()}))}},{key:"modFunction",value:function(t,e,n,r,i){var o=this;return Fe(u.mark((function s(){var c,a;return u.wrap((function(s){for(;;)switch(s.prev=s.next){case 0:return c=new Ie((function(r){Ve(t,e).then(r),setTimeout((function(){var e="Queued function timed out! ("+(t.name||"anonymous")+")";o.throwOnTimeout&&i(e),r(e)}),n)})),s.next=3,c;case 3:a=s.sent,o.stack.shift(),o.stack[0]?(o.executing=!0,r(a),o.stack[0]()):(o.executing=!1,r(a));case 6:case"end":return s.stop()}}),s,o)})))}},{key:"run",value:function(){this.executing||(this.executing=!0,this.stack[0]())}}]),t}();t.exports=new We}));e(o);const s=i.Mutex,c=1;var u=class{constructor(t,e){this.url=t,this.options=e,this.timeout=3e4,this.req={delay:this.options.requestDelay||500,counter:0},this.reconnect={delay:this.options.reconnectDelay||500,counter:0},this.lastHeartbeat=new Date,this.subscriptions=[],this.requests=[],this.requestIds=1,this.queue=o,this.mutex=new s,setInterval(async()=>{new Date-this.lastHeartbeat>this.timeout&&this.connection&&this.connection.readyState===c&&this.connection.close(1001,"Heartbeat took too long.")},this.timeout)}async connect(){const t=await this.mutex.acquire();await this._createConnection(),t()}awaitConnection(){return new Promise(t=>{const e=setInterval(()=>{this.connection&&this.connection.readyState===c&&(clearInterval(e),t())},100)})}async request(t,e){await this.awaitConnection();const n=await new Promise(n=>{const r=this.requestIds++,i={action:t,id:r};"string"==typeof e?i.url=e:(i.url=e.url,i.body=e.body),this.requests.push({id:r,resolve:n,verb:t,query:e});try{this.connection.send(JSON.stringify(i))}catch(t){this.requests.pop(),this.client.emit("error",t)}});return this._errCheck(n,t,e)}async reloadConnection(){await this.awaitConnection(),await this.connection.close(1001,"Reloading connection.")}async _retry(t,e,n){const r=t.body&&t.body.reason?parseInt(t.body.reason.replace(/[^0-9]+/g,"")):null,i=isNaN(r)?this.req.delay:r,o=this.queue.delay(this.request.bind(this,e,n),i*Math.pow(2,this.req.counter),5e3,"unshift");return this.req.counter++,o}async _reconnect(){if(this.connection&&this.connection.readyState<=c)return;const t=await this.mutex.acquire();await new Promise(t=>setTimeout(()=>t(),this.reconnect.delay*Math.pow(2,this.reconnect.counter))),this.reconnect.counter++,await this._createConnection(),t();for(let t=this.requests.length-1;t>=0;t--){const t=this.requests.pop();t.resolve(this._retry({},t.verb,t.query))}for(const t of this.subscriptions)this.client.send(JSON.stringify({action:"SUBSCRIBE",room:t.room}))}async _createConnection(){const e=this.apiAccessToken?{headers:{authorization:`bearer ${this.apiAccessToken}`}}:{},n=new t(this.url,e);n.onerror=t=>console.log(`WebSocket Error: ${t.message}`),n.onclose=t=>{1e3!==t.code&&this._reconnect()},n.onmessage=t=>this._onMessage(t.data),this.connection=n}async _onMessage(t){if("string"==typeof(t=JSON.parse(t))&&t.startsWith("primus::ping::"))this.lastHeartbeat=new Date,this.connection.send(JSON.stringify(t.replace("ping","pong"))),this.reconnect.counter=0;else if("RES"===t.action&&t.id){const e=this.requests.find(e=>e.id===t.id);e&&(this.requests=this.requests.filter(e=>e.id===t.id),e.resolve(t))}else if("PUBLISH"===t.action)for(const e of this.subscriptions)e.room===t.room&&e.fn(t.data)}async _errCheck(t,e,n){if("string"==typeof t&&t.includes("timed out"))return this._retry(t,e,n);if(t.body.error)throw t;return this.req.counter=0,t.body}};class a extends Error{constructor({statusCode:t,body:e},n){const r=e.error?e.error+`(${e.reason})`:e;super(`Cubic-client encountered an error while requesting ${n.url||n}: ${t} - ${r}`),this.statusCode=t,this.reason=e.reason,this.error=e.error}}var h=a;var f=class extends u{async setAccessToken(t){this.apiAccessToken=t}async _errCheck(t,e,n){if("string"==typeof t&&t.includes("timed out"))return this._retry(t,e,n);if(t.body&&t.body.reason&&t.body.reason.includes("jwt expired"))return{EXPIRED:!0,fn:this._retry.bind(this,t,e,n)};if(!t.statusCode&&t.includes("timed out"))return this._retry(t,e,n);if(429===t.statusCode)return this._retry(t,e,n);if(503===t.statusCode)return this._retry(t,e,n);if(parseInt(t.statusCode.toString()[0])>3)throw new h(t,n);return this.req.counter=0,t.body}};const l=i.Mutex;var p=class extends u{constructor(t,e){super(t,e),this.authMutex=new l}async authorize(t=this.refresh_token){if(t||this.options.user_key&&this.options.user_secret)return t?this._refreshToken():this._getTokens()}login(t,e){return this.options.user_key=t,this.options.user_secret=e,this._getTokens()}async _getTokens(){const t={user_key:this.options.user_key,user_secret:this.options.user_secret},e=await this.request("POST",{url:"/authenticate",body:t});this.access_token=e.access_token,this.refresh_token=e.refresh_token}async _refreshToken(){const t=await this.authMutex.acquire(),e={refresh_token:this.refresh_token},n=await this.request("POST",{url:"/refresh",body:e});this.access_token=n.access_token,t()}async _errCheck(t,e,n){return"string"==typeof t&&t.includes("timed out")?this._retry(t,e,n):t.statusCode>=400&&503!==t.statusCode&&404!==t.statusCode&&429!==t.statusCode?(console.error("Cubic-client encountered an error while authenticating:"),console.error(t.body),console.error("retrying... \n"),this._retry(t,e,n)):(this.req.counter=0,t.body)}};var d=class{constructor(t){this.options=t,this.options.isBrowser||(this.api=new f(this.options.api_url,this.options),this.auth=new p(this.options.auth_url,{user_key:this.options.user_key,user_secret:this.options.user_secret}))}awaitConnection(){return Promise.all([this.api.awaitConnection(),this.auth.awaitConnection()])}async connect(){await this.auth.connect(),await this.auth.authorize(),await this.api.setAccessToken(this.auth.access_token),await this.api.connect()}async query(t,e){const n=await this.api.request(t,e);return n.EXPIRED?(await this.auth.authorize(),await this.api.setAccessToken(this.auth.access_token),n.fn()):n}async subscribe(t,e){await this.api.awaitConnection(),this.api.connection.send(JSON.stringify({action:"SUBSCRIBE",room:t})),this.api.subscriptions.push({room:t,fn:e})}async unsubscribe(t){await this.api.awaitConnection(),this.api.connection.send(JSON.stringify({action:"UNSUBSCRIBE",room:t})),this.api.subscriptions=this.api.subscriptions.filter(e=>e.room!==t)}async login(t,e){await this.awaitConnection(),await this.auth.login(t,e),await this.api.setAccessToken(this.auth.access_token),await this.api.reloadConnection()}async setAccessToken(t){this.auth.access_token=t,await this.api.setAccessToken(this.auth.access_token),await this.api.reloadConnection()}};var y=class{constructor(t){this.options={api_url:"ws://localhost:3003/ws",auth_url:"ws://localhost:3030/ws",user_key:null,user_secret:null,...t};let e=this.options.api_url,n=this.options.auth_url;this.options.api_url="/"===e[e.length-1]?e.slice(0,-1):e,this.options.auth_url="/"===n[n.length-1]?n.slice(0,-1):n,this.client=new d(this.options),this.client.connect()}awaitConnection(){return this.client.awaitConnection()}subscribe(t,e){return this.client.subscribe(t,e)}unsubscribe(t){return this.client.unsubscribe(t)}get(t){return this.client.query("GET",t)}post(t,e){return this.client.query("POST",{url:t,body:e})}put(t,e){return this.client.query("PUT",{url:t,body:e})}patch(t,e){return this.client.query("PATCH",{url:t,body:e})}delete(t,e){return this.client.query("DELETE",{url:t,body:e})}login(t,e){return this.client.login(t,e)}async setRefreshToken(t){this.client.auth.refresh_token=t}async getRefreshToken(){return this.client.auth.refresh_token}setAccessToken(t){return this.client.setAccessToken(t)}async getAccessToken(){return this.client.auth.access_token}};module.exports=class extends y{};
//# sourceMappingURL=browser.js.map
